# -*- mode:tcl -*-
#------------------------------------------------------------------------------
# read input file with pre-mixed (at a level of StepPointMC's) background events, 
# run digitization 
#
# example:
# --------
# murat/scripts/submit_mu2e_job -v -c murat/test/conv_mixcd3_x1_stnmaker.fcl -S $PWD/datasets/ccd35600-local \
#                               -f 1:@bgHitFiles:datasets/cd3-detmix-cut-local-v2 -n 10 
#------------------------------------------------------------------------------
#include "fcl/minimalMessageService.fcl"
#include "fcl/standardProducers.fcl"
#include "fcl/standardServices.fcl"

#include "Stntuple/fcl/prolog.fcl"

BEGIN_PROLOG
#  meanBackground                      : -1        # fixed at 1
bgHitFiles                          : [ "/pnfs/mu2e/tape/phy-sim/sim/mu2e/cd3-detmix-cut/v566b/art/00/90/sim.mu2e.cd3-detmix-cut.v566b.000004_00000341.art" ]
  G4_MODULE_LABEL                     : "g4run"          # for normal generators and Ralf's cosmics
#  G4_MODULE_LABEL                     : "detectorFilter" # for Andrei's datasets 
END_PROLOG

#include "Stntuple/fcl/templates.fcl"

process_name : hitDisplay

source       : { 
#    module_type : EmptyEvent 
    module_type : RootInput 
#    fileNames: [ "/pnfs/mu2e/tape/phy-sim/sim/mu2e/cd3-detmix-cut/v566b/art/00/90/sim.mu2e.cd3-detmix-cut.v566b.000004_00000341.art" ]
#    fileNames: [ "/pnfs/mu2e/tape/phy-sim/sim/mu2e/cd3-beam-g4s4-detconversion/v566/50/b6/sim.mu2e.cd3-beam-g4s4-detconversion.v566.004001_00000000.art" ]
}
services : {
    message               : @local::default_message
    #    TFileService          : { fileName : "e11s6220.hist" }
    TFileService          : { fileName : "/mu2e/data/users/gianipez/hist/hitDisplay.hist" }

    RandomNumberGenerator : { }
    #   Timing                : { }

    GeometryService        : { inputFile      : "Mu2eG4/geom/geom_common_cd3_s4p2.txt" }
    ConditionsService      : { conditionsfile : "Mu2eG4/test/conditions_01.txt"        }
    GlobalConstantsService : { inputFile      : "Mu2eG4/test/globalConstants_01.txt"   }
    G4Helper               : { }
    BTrkHelper             : @local::BTrkHelperDefault
    SeedService            : { @table::automaticSeeds
	baseSeed         :  0
	maxUniqueEngines :  20
    }
    
}



services.TimeTracker : {
    dbOutput : {
	filename  : "" 
	overwrite : true
    }
}


physics: { 
    producers : { @table::producers 
	generate : { @table::StoppedParticleReactionGun 
	    physics : {
		pdgId            : 11
		elow             : 0.499
		ehi              : 0.501
		spectrumVariable : "momentum"
		spectrumShape    : "flat"
	    }
	    
	}

	@table::Tracking.producers

	makeSH            : { @table::TrkHitReco.producers.makeSH
	    minimumEnergy  : 0.0035
	    maximumEnergy  : 0.014
	}

#	FlagBkgHits       : { @table::TrkHitReco.producers.FlagBkgHits	}

	
	TimeClusterFinder : { @table::Tracking.producers.TimeClusterFinder
	    MinNHits   : 5
	    
	    T0Calculator  : {
		StrawHitBeta          : 0.1  #IMPROVE ME!
#		StrawHitVelocitySlope   #FIXME! 
	    }

	}

	HelixFinder        : { @table::Tracking.producers.HelixFinder
	    
	    RobustHelixFit : {
		minNHit : 5
		# LOOK THE EVENT DISPLAY TO UNDERSTAND IF WE NEED TO TUNE THESE PARAMETERS
		# minR    : 
		# maxR    : 
		#		minCenterR
		# maxCenterR:
	    }
	    
	    
	    T0Calculator  : {
		StrawHitBeta          : 0.1  #IMPROVE ME!
		#		StrawHitVelocitySlope   #FIXME! 
	    }
	} 


	# KSFDpP   : { @table::Tracking.producers.KSFDeM
	#     KalFit     : {@table::Tracking.producers.KSFDeM.KalFit

	#     }
	# }
	
	# KFFDeM   : { @table::Tracking.producers.KFFDeM
	#     KalFit     : {@table::Tracking.producers.KFFDeM.KalFit
	# 	useTrkCaloHit     : true
	#     }
	# }
    }

    filters : { @table::physics.filters
	
	@table::EventMixing.filters


	InitStntuple  : { @table::Stntuple.filters.InitStntuple 
	    histFileName : "test.stn"  
	    #	    histFileName : "e11s6220.stn"  
	}

	detectorFilter:     @local::FilterStepPointMomentum

	MuHitDisplay  : { @table::MuHitDisplay 
	    generatorModuleLabel         : "generate"
	    g4ModuleLabel                : "g4run"
	    strawHitFlagMakerModuleLabel : "FlagBkgHits:StrawHits"
 	    trkRecoModuleLabel           : "KFFDeM"
	}

    }

    p1: [
	 detectorFilter,
	 makeSH, makePH,
	 @sequence::CaloReco.Reco	       , 
	 @sequence::CaloCluster.Reco        , 

#	 PrefetchData,
	 #
	 FlagBkgHits,
	 #
	 TimeClusterFinder,
	 HelixFinder, 
	 KSFDeM, 
	 KFFDeM,
	 #
	 # MergeHelixFinder,
	 # MergePatRec,
	 # MergePatRecTpr,
	 # MergePatRecCpr,
	 # @sequence::trkCaloMatchingSeq,
	 # @sequence::trkCaloMatchingTprSeq,
	 # @sequence::trkCaloMatchingCprSeq,
	 #
	 MuHitDisplay
	 #	  @sequence::stnmaker3_seq 
	]
    
    trigger_paths : [  p1 ]
    out           : []
    end_paths     : [ out ]
}

#------------------------------------------------------------------------------
# redefine location of the mixer's background files
#------------------------------------------------------------------------------
physics.filters.flashMixer.fileNames    : @local::bgHitFiles
physics.filters.ootMixer.fileNames      : @local::bgHitFiles
physics.filters.dioMixer.fileNames      : @local::bgHitFiles
physics.filters.neutronMixer.fileNames  : @local::bgHitFiles
physics.filters.photonMixer.fileNames   : @local::bgHitFiles
physics.filters.protonMixer.fileNames   : @local::bgHitFiles
physics.filters.deuteronMixer.fileNames : @local::bgHitFiles
#------------------------------------------------------------------------------
# uncomment to write the DST out
#------------------------------------------------------------------------------
# physics.out : [detectorOutput]
 outputs.detectorOutput.fileName           : "sim.gianipez.bbb.ccc.read_reco_stn_tcn.art"
#------------------------------------------------------------------------------
# everything below is appended by murat/scripts/submit_mu2e_job
#------------------------------------------------------------------------------
# services.TFileService          : { fileName : "e10s6400.hist" }
